generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Restaurant {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  email               String?
  phone               String?
  address             String?
  logo                String?
  currency            String               @default("IQD")
  timezone            String               @default("Asia/Baghdad")
  settings            Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  addOns              AddOn[]
  aiInsights          AIInsight[]
  categories          Category[]
  deliveries          Delivery[]
  employees           Employee[]
  expenseTransactions ExpenseTransaction[]
  expenses            Expense[]
  ingredients         Ingredient[]
  mealPrepSessions    MealPrepSession[]
  menuItems           MenuItem[]
  payrolls            Payroll[]
  preppedDishStocks   PreppedDishStock[]
  sales               Sale[]
  shifts              Shift[]
  tables              Table[]
  users               User[]
  wasteRecords        WasteRecord[]
  chefPicks           ChefPick[]

  @@map("restaurants")
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  password     String
  name         String
  role         UserRole   @default(STAFF)
  restaurantId String
  isActive     Boolean    @default(true)
  defaultBackgroundPrompt String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([email])
  @@map("users")
}

model Ingredient {
  id                  String                   @id @default(cuid())
  name                String
  unit                String
  stockQuantity       Float
  costPerUnit         Float
  minStockLevel       Float
  supplier            String?
  notes               String?
  restaurantId        String
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  deliveries          Delivery[]
  expenseTransactions ExpenseTransaction[]
  restaurant          Restaurant               @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  mealPrepUsages      MealPrepInventoryUsage[]
  menuItemIngredients MenuItemIngredient[]
  stockAdjustments    StockAdjustment[]
  wasteRecords        WasteRecord[]

  @@index([restaurantId])
  @@index([stockQuantity])
  @@map("ingredients")
}

model StockAdjustment {
  id             String     @id @default(cuid())
  ingredientId   String
  quantityChange Float
  reason         String
  notes          String?
  timestamp      DateTime   @default(now())
  ingredient     Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@index([ingredientId])
  @@index([timestamp])
  @@map("stock_adjustments")
}

model Delivery {
  id                   String              @id @default(cuid())
  ingredientId         String
  supplierName         String
  quantity             Float
  unitCost             Float
  totalCost            Float
  deliveryDate         DateTime            @db.Date
  invoiceNumber        String?
  notes                String?
  expenseTransactionId String?
  restaurantId         String
  createdAt            DateTime            @default(now())
  transportCost        Float               @default(0)
  expenseTransaction   ExpenseTransaction? @relation(fields: [expenseTransactionId], references: [id])
  ingredient           Ingredient          @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  restaurant           Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([ingredientId])
  @@index([restaurantId])
  @@index([deliveryDate])
  @@map("deliveries")
}

model Category {
  id           String     @id @default(cuid())
  name         String
  description  String?
  displayOrder Int        @default(0)
  restaurantId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems    MenuItem[]

  @@index([restaurantId])
  @@index([displayOrder])
  @@map("categories")
}

model MenuItem {
  id              String                @id @default(cuid())
  name            String
  description     String?
  price           Float
  imageUrl        String?
  available       Boolean               @default(true)
  categoryId      String
  restaurantId    String
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  calories        Int?
  popularityScore Int                   @default(0)
  tags            String[]              @default([])
  cookTime        String?
  prepTime        String?
  recipeSteps     String[]              @default([])
  recipeTips      String[]              @default([])
  carbs           Int?
  protein         Int?
  addOns          MenuItemAddOn[]
  mealPrepItems   MealPrepItem[]
  ingredients     MenuItemIngredient[]
  translations    MenuItemTranslation[]
  category        Category              @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  restaurant      Restaurant            @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  preppedStock    PreppedDishStock?
  saleItems       SaleItem[]
  chefPicks       ChefPick[]

  @@index([restaurantId])
  @@index([categoryId])
  @@index([available])
  @@index([popularityScore])
  @@map("menu_items")
}

model ChefPick {
  id            String      @id @default(cuid())
  restaurantId  String
  menuItemId    String
  displayOrder  Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItem      MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, menuItemId])
  @@index([restaurantId])
  @@map("chef_picks")
}

model MenuItemIngredient {
  id           String     @id @default(cuid())
  menuItemId   String
  ingredientId String
  quantity     Float
  createdAt    DateTime   @default(now())
  pieceCount   Float?
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  menuItem     MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, ingredientId])
  @@index([menuItemId])
  @@index([ingredientId])
  @@map("menu_item_ingredients")
}

model MenuItemTranslation {
  id                    String                      @id @default(cuid())
  protein               Int?
  carbs                 Int?
  aiDescription         String
  createdAt             DateTime                    @default(now())
  language              MenuItemTranslationLanguage
  menuItemId            String
  sourceHash            String
  sourceUpdatedAt       DateTime
  translatedDescription String
  translatedName        String
  updatedAt             DateTime                    @updatedAt
  menuItem              MenuItem                    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, language])
  @@index([language])
  @@map("menu_item_translations")
}

model AddOn {
  id           String          @id @default(cuid())
  name         String
  price        Float
  description  String?
  available    Boolean         @default(true)
  restaurantId String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  menuItems    MenuItemAddOn[]
  restaurant   Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([available])
  @@map("add_ons")
}

model MenuItemAddOn {
  id         String   @id @default(cuid())
  menuItemId String
  addOnId    String
  createdAt  DateTime @default(now())
  addOn      AddOn    @relation(fields: [addOnId], references: [id], onDelete: Cascade)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, addOnId])
  @@index([menuItemId])
  @@index([addOnId])
  @@map("menu_item_add_ons")
}

model Sale {
  id                    String        @id @default(cuid())
  orderNumber           String
  total                 Float
  paymentMethod         PaymentMethod @default(CASH)
  status                OrderStatus   @default(PENDING)
  customerName          String?
  notes                 String?
  restaurantId          String
  timestamp             DateTime      @default(now())
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  paidAt                DateTime?
  tableId               String?
  waiterId              String?
  paymentProvider       String?
  stripePaymentIntentId String?
  items                 SaleItem[]
  restaurant            Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table                 Table?        @relation(fields: [tableId], references: [id])
  waiter                Employee?     @relation("WaiterSales", fields: [waiterId], references: [id])

  @@index([restaurantId])
  @@index([timestamp])
  @@index([orderNumber])
  @@index([status])
  @@map("sales")
}

model SaleItem {
  id         String   @id @default(cuid())
  saleId     String
  menuItemId String
  quantity   Int
  price      Float
  cost       Float
  createdAt  DateTime @default(now())
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  sale       Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([menuItemId])
  @@map("sale_items")
}

model Expense {
  id           String         @id @default(cuid())
  name         String
  category     String?
  amount       Float
  cadence      ExpenseCadence
  startDate    DateTime
  endDate      DateTime?
  restaurantId String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  restaurant   Restaurant     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([cadence])
  @@index([startDate])
  @@map("expenses")
}

model ExpenseTransaction {
  id           String          @id @default(cuid())
  name         String
  category     ExpenseCategory
  amount       Float
  date         DateTime        @db.Date
  notes        String?
  ingredientId String?
  quantity     Float?
  unitCost     Float?
  restaurantId String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  deliveries   Delivery[]
  ingredient   Ingredient?     @relation(fields: [ingredientId], references: [id])
  restaurant   Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([date])
  @@index([category])
  @@map("expense_transactions")
}

model MealPrepSession {
  id              String                   @id @default(cuid())
  prepDate        DateTime                 @db.Date
  sessionTime     String
  preparedBy      String?
  notes           String?
  restaurantId    String
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  inventoryUsages MealPrepInventoryUsage[]
  prepItems       MealPrepItem[]
  restaurant      Restaurant               @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([prepDate])
  @@map("meal_prep_sessions")
}

model MealPrepItem {
  id              String          @id @default(cuid())
  prepSessionId   String
  menuItemId      String
  quantityPrepped Int
  createdAt       DateTime        @default(now())
  menuItem        MenuItem        @relation(fields: [menuItemId], references: [id])
  prepSession     MealPrepSession @relation(fields: [prepSessionId], references: [id], onDelete: Cascade)

  @@index([prepSessionId])
  @@index([menuItemId])
  @@map("meal_prep_items")
}

model MealPrepInventoryUsage {
  id            String          @id @default(cuid())
  prepSessionId String
  ingredientId  String
  quantityUsed  Float
  createdAt     DateTime        @default(now())
  ingredient    Ingredient      @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  prepSession   MealPrepSession @relation(fields: [prepSessionId], references: [id], onDelete: Cascade)

  @@index([prepSessionId])
  @@index([ingredientId])
  @@map("meal_prep_inventory_usage")
}

model PreppedDishStock {
  id                String     @id @default(cuid())
  menuItemId        String     @unique
  availableQuantity Int        @default(0)
  restaurantId      String
  lastUpdated       DateTime   @default(now()) @updatedAt
  menuItem          MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  restaurant        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([availableQuantity])
  @@map("prepped_dish_stocks")
}

model WasteRecord {
  id           String     @id @default(cuid())
  ingredientId String
  quantity     Float
  cost         Float
  date         DateTime   @db.Date
  reason       String?
  notes        String?
  restaurantId String
  createdAt    DateTime   @default(now())
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([date])
  @@index([ingredientId])
  @@map("waste_records")
}

model AIInsight {
  id           String      @id @default(cuid())
  type         InsightType
  title        String
  content      String
  data         Json?
  priority     Priority    @default(NORMAL)
  restaurantId String
  validUntil   DateTime
  createdAt    DateTime    @default(now())
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([type])
  @@index([validUntil])
  @@index([createdAt])
  @@map("ai_insights")
}

model DailySummary {
  id            String   @id @default(cuid())
  date          DateTime @db.Date
  restaurantId  String
  revenue       Float
  cost          Float
  profit        Float
  marginPercent Float
  orderCount    Int
  itemsSold     Int
  avgOrderValue Float
  data          Json?
  createdAt     DateTime @default(now())

  @@unique([date, restaurantId])
  @@index([restaurantId])
  @@index([date])
  @@map("daily_summaries")
}

model Table {
  id           String      @id @default(cuid())
  number       String
  capacity     Int
  status       TableStatus @default(AVAILABLE)
  restaurantId String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  sales        Sale[]
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, number])
  @@index([restaurantId])
  @@index([status])
  @@map("tables")
}

model Employee {
  id           String           @id @default(cuid())
  name         String
  position     EmployeePosition
  phone        String?
  email        String?
  hireDate     DateTime         @default(now())
  salary       Float
  salaryType   SalaryType       @default(MONTHLY)
  isActive     Boolean          @default(true)
  restaurantId String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  restaurant   Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  payrolls     Payroll[]
  sales        Sale[]           @relation("WaiterSales")
  shifts       Shift[]

  @@index([restaurantId])
  @@index([position])
  @@index([isActive])
  @@map("employees")
}

model Payroll {
  id           String        @id @default(cuid())
  employeeId   String
  period       DateTime      @db.Date
  baseSalary   Float
  bonuses      Float         @default(0)
  deductions   Float         @default(0)
  totalPaid    Float
  notes        String?
  paidDate     DateTime?
  status       PayrollStatus @default(PENDING)
  restaurantId String
  createdAt    DateTime      @default(now())
  employee     Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([restaurantId])
  @@index([period])
  @@index([status])
  @@map("payrolls")
}

model Shift {
  id           String     @id @default(cuid())
  employeeId   String
  date         DateTime   @db.Date
  startTime    String
  endTime      String
  hoursWorked  Float?
  notes        String?
  restaurantId String
  createdAt    DateTime   @default(now())
  employee     Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([restaurantId])
  @@index([date])
  @@map("shifts")
}

enum UserRole {
  OWNER
  MANAGER
  STAFF
}

enum PaymentMethod {
  CASH
  CARD
  OTHER
  APPLE_PAY
}

enum MenuItemTranslationLanguage {
  en
  ar
  ku
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum ExpenseCadence {
  DAILY
  WEEKLY
  MONTHLY
  ANNUAL
}

enum ExpenseCategory {
  RENT
  UTILITIES
  INVENTORY_PURCHASE
  MARKETING
  MAINTENANCE
  OTHER
}

enum InsightType {
  REVENUE_FORECAST
  DEMAND_PREDICTION
  INVENTORY_ALERT
  MENU_OPTIMIZATION
  PRICING_RECOMMENDATION
  PEAK_TIME_ANALYSIS
  COST_ALERT
}

enum Priority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  CLEANING
}

enum EmployeePosition {
  WAITER
  CHEF
  KITCHEN_STAFF
  CASHIER
  MANAGER
  CLEANER
}

enum SalaryType {
  HOURLY
  DAILY
  MONTHLY
}

enum PayrollStatus {
  PENDING
  PAID
  CANCELLED
}
